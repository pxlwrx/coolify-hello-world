# Coolify deployment configuration for Hello World System Info Terminal
# This file defines how Coolify should build and deploy the application

version: "1.0"

metadata:
  name: "coolify-hello-world"
  description: "Terminal-style system information display for homelab monitoring"
  version: "1.0.0"
  tags:
    - "system-info"
    - "terminal"
    - "monitoring"
    - "homelab"
    - "docker"

# Application configuration
application:
  name: "coolify-hello-world"
  type: "dockerfile"
  dockerfile: "Dockerfile"
  build_context: "."

  # Port configuration
  ports:
    - container_port: 3000
      public_port: 80
      protocol: "http"
      name: "web"

  # Health check configuration
  health_check:
    enabled: true
    path: "/api/system"
    port: 3000
    interval: 30
    timeout: 10
    retries: 3
    start_period: 40
    method: "GET"
    expected_status_codes: [200]

  # Resource limits
  resources:
    limits:
      memory: "512Mi"
      cpu: "500m"
    requests:
      memory: "128Mi"
      cpu: "100m"

  # Restart policy
  restart_policy: "unless-stopped"

# Build configuration
build:
  dockerfile: "Dockerfile"
  context: "."
  target: "runner"

  # Build arguments
  args:
    NODE_ENV: "production"
    PORT: "3000"

  # Build-time environment variables
  build_env:
    NEXT_TELEMETRY_DISABLED: "1"
    NODE_OPTIONS: "--max-old-space-size=512"

# Environment variables
environment:
  # Application settings
  NODE_ENV: "production"
  PORT: "3000"
  HOSTNAME: "0.0.0.0"

  # App configuration
  APP_NAME: "coolify-hello-world"
  APP_VERSION: "1.0.0"

  # System settings
  TZ: "UTC"
  LANG: "en_US.UTF-8"

  # Performance settings
  REFRESH_INTERVAL: "5000"
  SHOW_ASCII_ART: "true"
  TERMINAL_THEME: "green"

  # Next.js settings
  NEXT_TELEMETRY_DISABLED: "1"

  # Container info
  IMAGE_NAME: "coolify-hello-world:latest"
  CONTAINER_NAME: "coolify-hello-world-app"

  # Security
  DISABLE_X_POWERED_BY: "true"

  # Logging
  LOG_LEVEL: "info"
  LOG_FORMAT: "combined"

# Secrets (to be set in Coolify UI)
secrets:
  - name: "API_SECRET_KEY"
    description: "Secret key for API authentication (if needed)"
    required: false

  - name: "ANALYTICS_ID"
    description: "Analytics tracking ID (optional)"
    required: false

# Volume mounts (if needed for persistent data)
volumes:
  - type: "tmpfs"
    target: "/tmp"
    options:
      size: "100m"

  - type: "tmpfs"
    target: "/app/.next/cache"
    options:
      size: "200m"

# Network configuration
network:
  mode: "bridge"

  # Custom domains
  domains:
    - pattern: "hello-world.local"
      redirect_to_https: true

    - pattern: "system-info.homelab"
      redirect_to_https: true

# Security configuration
security:
  # Run as non-root user
  run_as_user: 1001
  run_as_group: 1001

  # Security options
  no_new_privileges: true
  read_only_root_filesystem: false

  # Capabilities
  drop_capabilities: ["ALL"]
  add_capabilities: ["CHOWN", "SETGID", "SETUID"]

# Labels for container management
labels:
  coolify.managed: "true"
  coolify.type: "application"
  coolify.version: "1.0.0"
  app.name: "coolify-hello-world"
  app.type: "system-monitor"
  app.environment: "production"
  traefik.enable: "true"

# Deployment strategy
deployment:
  strategy: "rolling_update"

  rolling_update:
    max_unavailable: 0
    max_surge: 1

  # Pre-deployment hooks
  hooks:
    pre_deploy:
      - name: "health_check"
        command: ["./healthcheck.sh"]
        timeout: 30

    post_deploy:
      - name: "verify_deployment"
        command: ["curl", "-f", "http://localhost:3000/api/system"]
        timeout: 15

# Monitoring and logging
monitoring:
  # Enable container stats
  stats: true

  # Log configuration
  logging:
    driver: "json-file"
    options:
      max_size: "10m"
      max_file: "3"

  # Metrics endpoints
  metrics:
    enabled: true
    path: "/api/system"
    port: 3000

# Backup configuration (if needed)
backup:
  enabled: false
  # No persistent data to backup for this application

# Additional metadata for Coolify dashboard
ui:
  icon: "üñ•Ô∏è"
  color: "#00ff00"
  category: "monitoring"

  # Quick actions in Coolify UI
  actions:
    - name: "View System Info"
      url: "/api/system"
      icon: "üìä"

    - name: "View Logs"
      action: "logs"
      icon: "üìù"

    - name: "Restart Service"
      action: "restart"
      icon: "üîÑ"

# Git repository configuration (if using Git deployment)
git:
  branch: "main"
  auto_deploy: true

  # Build triggers
  triggers:
    - branch: "main"
      auto_build: true

    - tag_pattern: "v*"
      auto_build: true

# Development and staging overrides
environments:
  development:
    environment:
      NODE_ENV: "development"
      LOG_LEVEL: "debug"
      REFRESH_INTERVAL: "2000"

    resources:
      limits:
        memory: "256Mi"
        cpu: "250m"

  staging:
    environment:
      NODE_ENV: "staging"
      LOG_LEVEL: "info"

    domains:
      - pattern: "hello-world-staging.local"
        redirect_to_https: false

# Feature flags
features:
  auto_ssl: true
  force_https: true
  enable_logging: true
  enable_metrics: true
  enable_backup: false
  enable_monitoring: true
